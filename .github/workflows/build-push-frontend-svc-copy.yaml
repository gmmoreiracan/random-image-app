name: frontend-svc build and push copy

on:
  push:
    paths:
      - 'frontend-app/**'
      - '.github/workflows/build-push-frontend-svc copy.yaml'
    branches:
      - 'main'

jobs:
  docker:
    permissions:
      actions: read
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    steps:
      -
        name: Generate SBOM
        id: sbom-generator
        uses: anchore/sbom-action@v0.15.8
        with:
          image: 'docker.io/gmmeng/frontend-svc:latest'
          artifact-name: 'frontend-svc.spdx.json'
          output-file: '/tmp/frontend-svc.spdx.json'
      - 
        uses: anchore/sbom-action/publish-sbom@v0.15.8
        with:
          sbom-artifact-match: ".*\\.spdx$"
      # Step to output the exact location of file frontend-svc.spdx.json by running a command to find the file and providing the output to the next step.
      - name: Output SBOM file location
        run: |
          echo "SBOM file location: $(find /tmp -name frontend-svc.spdx.json)"
          echo "::set-output name=sbom::$(find /tmp -name frontend-svc.spdx.json)"
      
      ## Send spdx file to ServiceNow API. Only data contained inside JSON's "packages" array will be sent to ServiceNow API. Also need to provide the image digest from step "build_and_push" to the ServiceNow API.
      - name: Send SBOM to ServiceNow API
        run: |
          echo "Sending SBOM to ServiceNow API"
          echo "SBOM: @/tmp/frontend-svc.spdx.json"
          echo "Image Digest: sha256:19b1b18c3640a622dbd1929b1e8490d95ade6313b9851a3b5ce84de746120df5"
          echo "Sending SBOM to ServiceNow API"
          curl -X POST -H "Content-Type: application/json" -d "{\"imageDigest\":\"sha256:19b1b18c3640a622dbd1929b1e8490d95ade6313b9851a3b5ce84de746120df5\",\"sbom\":\"$(cat /tmp/frontend-svc.spdx.json)\"}" ${{secrets.SERVICENOW_API_URL}}
